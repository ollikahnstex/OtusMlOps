# Отчёт по ДЗ №3

## Очистка данных
В рамках ДЗ в Yandex Cloud Object Storage был создан новый bucket:  
**https://storage.yandexcloud.net/otus-mlops-dproc**.  
![Новый bucket](hw3_img/new_bucket.PNG "Новый bucket")  

Был создан новый Spark-кластер с привязкой к данному bucket'у.  

![Новый Spark-кластер](hw3_img/new_spark_cluster.PNG "Новый Spark-кластер")  
Соответствующим образом была настроена группа безопасности.  
![Настройка группы безопасности](hw3_img/cluster_secgroup_in.PNG "Настройка группы безопасности")  
![Настройка группы безопасности](hw3_img/cluster_secgroup_out.PNG "Настройка группы безопасности")  

Для анализа данных использовал Jupyter Notebook на мастер-ноде кластера. Создал виртуальное окружение,
подключил его к Kernel'ам, создал сессию подключения к s3-хранилищу с данными по транзакциям.  
![Jupyter Notebook а Spark-кластере](hw3_img/jupyter_on_spark_cluster.PNG "Jupyter Notebook а Spark-кластере")  

Данные из s3-хранилища небольшим объёмом (тысяч по 10-50 строк из пары файлов) шли быстро (пара минут),
а вот объёме 10 млн. строк уже выгружались заметно дольше.  
![Выгрузка данных из объектного хранилища](hw3_img/data_from_s3.PNG "Выгрузка данных из объектного хранилища")  
По каким-то причинам периодически подключение к кластеру терялось, и kernel вырубался, а соответственно
данные выпадали из оператвной памяти. Много времени на это ушло, поэтому решил всё-таки перенести данные
на Spark-кластер на время обработки по аналогии с ДЗ №2 (возможно, так и подразумевалось изначально).  

Обработка данных шла крайне долго: фильтрации и/или агрегации занимали 5-15 минут. В связи с этим
было решено для составления скрипта вести анализ только на одном файле датасета.  
![Файл примера данных](hw3_img/example_data.PNG "Файл примера данных")  
![Начало_анализа](hw3_img/example_data_analysis.PNG "Начало_анализа")  

Jupyter Notebook с тестовой обработкой данных:
[data_cleaning.ipynb](data_cleaning.ipynb)

После отладки кода на тестовом примере был написан python-скрипт обработки данных на PySpark:
[data_cleaning.py](../data_cleaning.py)

Данный скрипт принимает на вход путь до файла на HDFS Spark-кластера, чистит файл и сохраняет его в формате
`parquet` на s3-хранилище в ранее созданном бакете **https://storage.yandexcloud.net/otus-mlops-dproc**.
Для запуска этого скрипта на каждом файле с транзакциями из HDFS я выполнили bash-команду, которая
составляет список путей до всех файлов `.txt` на HDFS и передаёт их имена в python-скрипт.
```bash
hdfs dfs -ls /user/ubuntu/fraud_data | grep .txt$ | awk '{print $8}' | while read fn; do python ../data_cleaning.py $fn; done
```
![Работа скрипта](hw3_img/process_all_data.PNG "Работа скрипта")  
Обработка одно файла занимала около получаса (далее в статистике есть время каждого этапа очистки, однако
не фиксировалось время создания Spark-сессии и время сохранения файла).


## Статистика очистки файлов
1. Файл `2019-08-22.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46988418.
        - Размер датасета после очистки: 46988237.
        - Количество удалённых строк: 181.
        - Продолжительность этапа: 249.72 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46988237.
        - Размер датасета после очистки: 46988173.
        - Количество удалённых строк: 64.
        - Продолжительность этапа: 247.24 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46988173.
        - Размер датасета после очистки: 46987289.
        - Количество удалённых строк: 884.
        - Продолжительность этапа: 256.49 сек.
    5. Размер файла в формате `.parquet`: 
2. Файл `2019-09-21.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46994586.
        - Размер датасета после очистки: 46994586.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 308.44 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46994586.
        - Размер датасета после очистки: 46994211.
        - Количество удалённых строк: 375.
        - Продолжительность этапа: 348.90 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46994211.
        - Размер датасета после очистки: 46993291.
        - Количество удалённых строк: 920.
        - Продолжительность этапа: 341.34 сек.
    5. Размер файла в формате `.parquet`: 
3. Файл `2019-10-21.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46994432.
        - Размер датасета после очистки: 46994326.
        - Количество удалённых строк: 106.
        - Продолжительность этапа: 311.40 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46994326.
        - Размер датасета после очистки: 46994326.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 352.11 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46994326.
        - Размер датасета после очистки: 46993489.
        - Количество удалённых строк: 837.
        - Продолжительность этапа: 321.23 сек.
    5. Размер файла в формате `.parquet`: 
4. Файл `2019-11-20.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46992239.
        - Размер датасета после очистки: 46992150.
        - Количество удалённых строк: 89.
        - Продолжительность этапа: 327.18 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46992150.
        - Размер датасета после очистки: 46992038.
        - Количество удалённых строк: 112.
        - Продолжительность этапа: 317.32 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46992038.
        - Размер датасета после очистки: 46991146.
        - Количество удалённых строк: 892.
        - Продолжительность этапа: 316.91 сек.
    5. Размер файла в формате `.parquet`: 
5. Файл `2019-12-20.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46994937.
        - Размер датасета после очистки: 46994937.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 334.35 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46994937.
        - Размер датасета после очистки: 46994937.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 321.80 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46994937.
        - Размер датасета после очистки: 46994074.
        - Количество удалённых строк: 863.
        - Продолжительность этапа: 325.63 сек.
    5. Размер файла в формате `.parquet`: 
6. Файл `2019-01-19.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46986197.
        - Размер датасета после очистки: 46986151.
        - Количество удалённых строк: 46.
        - Продолжительность этапа: 285.63 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46986151.
        - Размер датасета после очистки: 46986142.
        - Количество удалённых строк: 9.
        - Продолжительность этапа: 281.74 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46986142.
        - Размер датасета после очистки: 46985273.
        - Количество удалённых строк: 869.
        - Продолжительность этапа: 268.58 сек.
    5. Размер файла в формате `.parquet`: 
7. Файл `2019-02-18.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46994271.
        - Размер датасета после очистки: 46994271.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 303.01 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46994271.
        - Размер датасета после очистки: 46994271.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 288.38 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46994271.
        - Размер датасета после очистки: 46993408.
        - Количество удалённых строк: 863.
        - Продолжительность этапа: 287.85 сек.
    5. Размер файла в формате `.parquet`: 
8. Файл `2019-03-19.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46990424.
        - Размер датасета после очистки: 46990424.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 338.32 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46990424.
        - Размер датасета после очистки: 46990065.
        - Количество удалённых строк: 359.
        - Продолжительность этапа: 339.36 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46990065.
        - Размер датасета после очистки: 46989187.
        - Количество удалённых строк: 878.
        - Продолжительность этапа: 324.48 сек.
    5. Размер файла в формате `.parquet`: 
9. Файл `2020-04-18.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 47001235.
        - Размер датасета после очистки: 47001180.
        - Количество удалённых строк: 55.
        - Продолжительность этапа: 515.94 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 47001180.
        - Размер датасета после очистки: 47000280.
        - Количество удалённых строк: 900.
        - Продолжительность этапа: 287.03 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 47000280.
        - Размер датасета после очистки: 46999395.
        - Количество удалённых строк: 885.
        - Продолжительность этапа: 318.00 сек.
    5. Размер файла в формате `.parquet`: 
10. Файл `2020-05-18.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46998002.
        - Размер датасета после очистки: 46997815.
        - Количество удалённых строк: 187.
        - Продолжительность этапа: 323.69 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46997815.
        - Размер датасета после очистки: 46997815.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 325.62 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46997815.
        - Размер датасета после очистки: 46996951.
        - Количество удалённых строк: 864.
        - Продолжительность этапа: 342.92 сек.
    5. Размер файла в формате `.parquet`: 
11. Файл `2020-06-17.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46983063.
        - Размер датасета после очистки: 46983063.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 312.45 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46983063.
        - Размер датасета после очистки: 46982126.
        - Количество удалённых строк: 937.
        - Продолжительность этапа: 313.06 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46982126.
        - Размер датасета после очистки: 46981199.
        - Количество удалённых строк: 927.
        - Продолжительность этапа: 311.48 сек.
    5. Размер файла в формате `.parquet`: 
12. Файл `2020-07-17.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 47000292.
        - Размер датасета после очистки: 47000292.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 316.36 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 47000292.
        - Размер датасета после очистки: 46999943.
        - Количество удалённых строк: 349.
        - Продолжительность этапа: 299.80 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46999943.
        - Размер датасета после очистки: 46999075.
        - Количество удалённых строк: 868.
        - Продолжительность этапа: 296.91 сек.
    5. Размер файла в формате `.parquet`: 
13. Файл `2020-08-16.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 47003159.
        - Размер датасета после очистки: 47003159.
        - Количество удалённых строк: 0.
        - Продолжительность этапа: 325.47 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 47003159.
        - Размер датасета после очистки: 47002441.
        - Количество удалённых строк: 718.
        - Продолжительность этапа: 275.42 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 47002441.
        - Размер датасета после очистки: 47001626.
        - Количество удалённых строк: 815.
        - Продолжительность этапа: 280.50 сек.
    5. Размер файла в формате `.parquet`: 
14. Файл `2020-09-15.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46999865.
        - Размер датасета после очистки: 46999844.
        - Количество удалённых строк: 21.
        - Продолжительность этапа: 251.75 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46999844.
        - Размер датасета после очистки: 46999059.
        - Количество удалённых строк: 785.
        - Продолжительность этапа: 264.27 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46999059.
        - Размер датасета после очистки: 46998188.
        - Количество удалённых строк: 871.
        - Продолжительность этапа: 248.97 сек.
    5. Размер файла в формате `.parquet`: 
15. Файл `2020-10-15.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 47001238.
        - Размер датасета после очистки: 47001093.
        - Количество удалённых строк: 145.
        - Продолжительность этапа: 358.91 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 47001093.
        - Размер датасета после очистки: 47000928.
        - Количество удалённых строк: 165.
        - Продолжительность этапа: 351.47 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 47000928.
        - Размер датасета после очистки: 47000076.
        - Количество удалённых строк: 852.
        - Продолжительность этапа: 339.41 сек.
    5. Размер файла в формате `.parquet`: 
16. Файл `2020-11-14.txt`.
    1. Размер файла в формате `.txt`: 
    2. Этап очистки "Удаление полных дубликатов":
        - Размер датасета до очистки: 46995020.
        - Размер датасета после очистки: 46994835.
        - Количество удалённых строк: 185.
        - Продолжительность этапа: 313.54 сек.
    3. Этап очистки "Удаление отрицательных индентификаторов клиентов":
        - Размер датасета до очистки: 46994835.
        - Размер датасета после очистки: 46994608.
        - Количество удалённых строк: 227.
        - Продолжительность этапа: 308.32 сек.
    4. Этап очистки "Удаление строк с нулевым объёмом перевода":
        - Размер датасета до очистки: 46994608.
        - Размер датасета после очистки: 46993703.
        - Количество удалённых строк: 905.
        - Продолжительность этапа: 307.52 сек.
    5. Размер файла в формате `.parquet`: 

